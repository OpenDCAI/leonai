"""
å±é™©å‘½ä»¤æ‹¦æˆª Hook - ç¤ºä¾‹æ¨¡æ¿

å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º dangerous_commands.py å³å¯å¯ç”¨ã€‚
"""

from .base import BashHook, HookResult
from typing import Any


class DangerousCommandsHook(BashHook):
    """
    æ‹¦æˆªå±é™©çš„ç³»ç»Ÿå‘½ä»¤
    
    åŠŸèƒ½ï¼š
    - æ‹¦æˆª rm -rf /
    - æ‹¦æˆªæ ¼å¼åŒ–å‘½ä»¤
    - æ‹¦æˆªè¦†ç›–ç£ç›˜å‘½ä»¤
    """
    
    priority = 15  # é«˜ä¼˜å…ˆçº§ï¼Œåœ¨è·¯å¾„æ£€æŸ¥ä¹‹å
    name = "DangerousCommands"
    description = "Block dangerous system commands that could damage the system"
    enabled = True
    
    # å±é™©å‘½ä»¤æ¨¡å¼åˆ—è¡¨
    DANGEROUS_PATTERNS = [
        "rm -rf /",
        "rm -rf /*",
        "mkfs",
        "dd if=/dev/zero",
        "> /dev/sd",
        "chmod -R 777 /",
        "chown -R",
    ]
    
    def check_command(self, command: str, context: dict[str, Any]) -> HookResult:
        """æ£€æŸ¥å‘½ä»¤æ˜¯å¦åŒ…å«å±é™©æ“ä½œ"""
        
        # æ£€æŸ¥æ¯ä¸ªå±é™©æ¨¡å¼
        for pattern in self.DANGEROUS_PATTERNS:
            if pattern in command:
                return HookResult.block_command(
                    error_message=(
                        f"âŒ DANGER: Command contains dangerous pattern '{pattern}'\n"
                        f"   Command: {command}\n"
                        f"   Reason: This command could damage your system\n"
                        f"   ğŸ’¡ If you really need to run this, please ask the user for explicit permission."
                    )
                )
        
        # å‘½ä»¤å®‰å…¨
        return HookResult.allow_command()
    
    def on_command_error(self, command: str, error: str, context: dict[str, Any]) -> None:
        """è®°å½•è¢«æ‹¦æˆªçš„å±é™©å‘½ä»¤"""
        if "DANGER" in error:
            # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘Šè­¦ã€æ—¥å¿—ç­‰
            print(f"[SECURITY ALERT] Blocked dangerous command: {command}")
