# 历史导航功能说明

## 🎯 三种历史导航方式

### 1. ⭐ 双击 ESC - 可视化历史浏览器（推荐）

**使用方法**:
1. 按两次 `ESC` 键（间隔 < 0.5 秒）
2. 弹出历史记录列表（最新的在上面）
3. 用 `↑/↓` 方向键选择
4. 按 `Enter` 确认选择
5. 按 `ESC` 取消

**优点**:
- 可视化界面，一目了然
- 支持方向键导航
- 显示完整历史列表
- 最符合现代 TUI 交互习惯

**示例**:
```
┌─────────────────────────────────────────────────────────────┐
│                    📜 历史输入记录                           │
├─────────────────────────────────────────────────────────────┤
│ 5. 创建一个 Python 文件                                      │
│ 4. 读取 README.md 文件                                       │
│ 3. 搜索所有 .py 文件                                         │
│ 2. 列出当前目录                                              │
│ 1. 你好                                                      │
├─────────────────────────────────────────────────────────────┤
│           ↑/↓: 选择  Enter: 确认  ESC: 取消                 │
└─────────────────────────────────────────────────────────────┘
```

---

### 2. Slash 命令方式

#### `/history` - 查看历史
打开历史浏览器（同双击 ESC）

#### `/rollback N` 或 `/回退 N` - 快速回退
直接回退到倒数第 N 条输入

**示例**:
```
> /rollback 2
✓ 已回退到 2 步前的输入

> /回退 3
✓ 已回退到 3 步前的输入
```

**用法**:
- `/rollback 1` - 回退到上一条输入
- `/rollback 5` - 回退到倒数第 5 条输入
- 支持中文: `/回退 2`

---

### 3. Ctrl+↑/↓ 方式（保留）

**使用方法**:
- `Ctrl+↑` - 浏览上一条历史
- `Ctrl+↓` - 浏览下一条历史

**注意**: 某些终端环境可能不支持此快捷键，推荐使用双击 ESC 方式

---

## 📊 功能对比

| 方式 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **双击 ESC** | 可视化、直观、支持方向键 | 需要按两次 ESC | ⭐⭐⭐⭐⭐ |
| **Slash 命令** | 快速、精确回退 | 需要记住命令 | ⭐⭐⭐⭐ |
| **Ctrl+↑/↓** | 类似终端习惯 | 部分终端不支持 | ⭐⭐⭐ |

---

## 🧪 测试方法

### 测试双击 ESC
```bash
python test_tui_features.py
```

1. 发送 3-5 条不同的消息
2. 快速按两次 `ESC`
3. 应该看到历史浏览器弹窗
4. 用方向键选择，按 Enter 确认
5. 输入框应该填充选中的历史记录

### 测试 Slash 命令
1. 发送几条消息
2. 输入 `/history` 并回车 - 应该打开历史浏览器
3. 输入 `/rollback 2` 并回车 - 应该回退到倒数第 2 条
4. 输入 `/回退 1` 并回车 - 应该回退到上一条

---

## 🎨 UI 设计

### 历史浏览器样式
- 宽度: 80 字符
- 高度: 20 行
- 边框: 粗线框（primary 颜色）
- 背景: surface 颜色
- 选中项: primary 高亮背景

### 交互反馈
- 选择成功: `✓ 已加载历史记录 #N`
- 回退成功: `✓ 已回退到 N 步前的输入`
- 无历史: `暂无历史记录`
- 参数错误: `⚠ 回退步数必须在 1-N 之间`

---

## 🔧 实现细节

### 双击 ESC 检测
```python
def check_double_esc(self) -> bool:
    current_time = time.time()
    if current_time - self._last_esc_time < 0.5:  # 500ms 阈值
        self._last_esc_time = 0
        return True
    else:
        self._last_esc_time = current_time
        return False
```

### 历史索引计算
- 历史列表倒序显示（最新在上）
- 实际索引 = `len(history) - 1 - display_index`
- 回退索引 = `len(history) - steps`

---

## 💡 使用建议

### 场景 1: 快速重复命令
使用 `/rollback 1` 或双击 ESC 选择最后一条

### 场景 2: 修改之前的输入
1. 双击 ESC 打开历史
2. 选择要修改的输入
3. 编辑后发送

### 场景 3: 浏览所有历史
1. 输入 `/history`
2. 方向键浏览所有记录
3. 按 ESC 关闭（不选择）

---

## 🐛 已知问题

### 双击 ESC 在某些终端可能不灵敏
**解决方案**: 调整 `_esc_double_click_threshold` 参数（默认 0.5 秒）

### Ctrl+↑/↓ 在某些终端被拦截
**解决方案**: 使用双击 ESC 或 slash 命令代替

---

## 🚀 未来优化

1. **搜索历史**: 在历史浏览器中添加搜索功能
2. **收藏历史**: 标记常用命令
3. **历史分组**: 按会话或日期分组
4. **历史统计**: 显示最常用的命令
