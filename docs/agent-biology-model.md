# Agent 系统的生物学模型

基于生物细胞系统的类比，探索 Agent 系统的设计。

---

## 一、核心类比

| 生物 | Agent |
|------|-------|
| DNA | 基础 LLM（所有 Agent 共享） |
| 基因 | Prompt 片段 + Tool 定义 |
| 基因表达 | 激活哪些 prompt + tools |
| 细胞 | 一个独立的对话上下文 |
| 干细胞 | Stem Agent（可分裂、可分化） |
| 特化细胞 | Worker Agent（Explorer、Coder...） |
| 信号分子 | 任务消息、状态事件 |
| 受体 | Agent 的能力声明 |
| 细胞凋亡 | Agent 自主销毁 |
| 龛位（Niche） | Agent 运行环境（资源、权限、工具集） |

---

## 二、演化 vs 分化

| | 演化 | 分化 |
|--|------|------|
| 层面 | 物种 | 个体 |
| 时间 | 跨代际，百万年 | 一个生命周期内 |
| 机制 | 变异 + 自然选择 | 基因表达调控 |
| 结果 | 新物种 | 新细胞类型 |

**当前阶段应该关注分化，不是演化。**

---

## 三、龛位（Niche）

干细胞不是随便待在哪里都能保持干性，需要特定的**微环境**。

### 生物龛位的三要素

| 要素 | 生物 | Agent |
|------|------|-------|
| **物理** | ECM、硬度、氧浓度 | 运行时沙箱、资源限制、信息可及性 |
| **化学** | Wnt、Notch、BMP 信号 | System Prompt、上下文、任务信号 |
| **细胞** | 支持细胞、免疫细胞 | 中间件、Hook 系统、基础设施 |

### Agent 龛位设计

```yaml
niche:
  physical:
    workspace_root: "/project"
    resource_limits:
      max_tokens: 100000
      timeout_seconds: 300

  chemical:
    wnt_signal: system_prompt      # 维持核心身份
    bmp_signal: task_completion    # 触发分化/凋亡
    growth_factors: [tools]        # 外部能力注入

  cellular:
    paneth_cells: [middleware/*]   # 工具提供者
    tregs: [hooks/*]               # 安全守卫
```

**关键洞见**：Agent 命运由环境决定，不是硬编码。

---

## 四、分化机制

### 分子机制映射

| 生物机制 | Agent 对应 |
|---------|-----------|
| 转录因子（MyoD、Pax6） | 特化 System Prompt |
| 表观遗传（DNA 甲基化） | 上下文累积、状态锁定 |
| 信号通路（Wnt、Notch） | 任务类型、环境信号 |

### 分化触发

```
信号出现（任务入队）
    ↓
Stem Agent 感知
    ↓
阈值判断 + 时间窗口 + 组合信号
    ↓
激活特定 prompt + tools
    ↓
成为特化 Agent
```

### 分化的可逆性

| 层级 | 可逆性 | 说明 |
|------|--------|------|
| Stem → Progenitor | ✅ 可逆 | 保留快照，可回退 |
| Progenitor → Terminal | ❌ 不可逆 | 任务完成后凋亡 |

**设计原则**：分化深度与可逆性负相关。

---

## 五、分裂与平衡

### 对称 vs 非对称分裂

```
对称分裂：1 Stem → 2 Stem（扩增，用于启动/恢复）
非对称分裂：1 Stem → 1 Stem + 1 Worker（稳态维持）
```

### 防止失控（类比癌症抑制）

| 生物机制 | Agent 对应 |
|---------|-----------|
| p53（损伤检测） | 资源监控器 |
| p21（周期抑制） | 任务队列限制 |
| RB（增殖门控） | 生成数量上限 |
| 凋亡 | 超时/错误自毁 |

```python
class SpawnControl:
    max_agents: int = 10           # 总数上限
    max_per_type: int = 3          # 同类型上限
    cooldown: float = 1.0          # 分裂冷却

    def can_spawn(self) -> bool:
        return (
            self.current_count < self.max_agents and
            self.resource_available() and
            self.cooldown_elapsed()
        )
```

---

## 六、通讯机制

### 四种通讯方式

| 方式 | 生物 | Agent | 适用场景 |
|------|------|-------|---------|
| **内分泌** | 激素全身广播 | 全局事件总线 | 系统配置、紧急通知 |
| **旁分泌** | 局部信号扩散 | 局部消息队列 | 工作流协调 |
| **自分泌** | 自己分泌自己响应 | 内部反馈循环 | 自我调节 |
| **接触依赖** | 细胞直接接触 | 直接调用/共享内存 | 紧密协作 |
| **神经信号** | 突触快速传递 | 点对点 RPC | 关键控制指令 |

### 为什么需要"神经系统"

化学信号（消息队列）的问题：
- 速度慢（扩散延迟）
- 精度低（广播式）
- 信号衰减

神经信号（直接通道）解决：
- 毫秒级响应
- 点对点精确
- 无衰减

**设计**：关键路径用直接通道，一般协调用消息队列。

---

## 七、凋亡与清除

### 凋亡触发（两条通路）

**内源性（自我检测）**：
```
资源耗尽 / 错误累积 / 长期空闲
    ↓
内部检查点触发
    ↓
程序性凋亡
```

**外源性（外部信号）**：
```
终止信号 / 父 Agent 死亡 / 超时
    ↓
死亡受体激活
    ↓
程序性凋亡
```

### 清除机制

| 层级 | 机制 | 说明 |
|------|------|------|
| L1 | 自清理 | Agent 释放自己的资源 |
| L2 | 被动 GC | WeakRef 自动回收 |
| L3 | 主动巡逻 | 清道夫定期扫描 |
| L4 | 强制清理 | 僵尸检测 + 强制终止 |

### 防止僵尸 Agent

```python
class ZombieDetector:
    timeout: float = 60.0  # 凋亡超时

    def detect(self, agent: Agent) -> bool:
        return (
            agent.state == "apoptotic" and
            time.now() - agent.apoptosis_start > self.timeout
        )
```

---

## 八、涌现与自组织

### 什么必须预设

| 预设内容 | 生物类比 | 说明 |
|---------|---------|------|
| 通信协议 | 信号分子 + 受体 | Agent 间如何交换信息 |
| 基本工具集 | 分子工具箱 | 原子操作能力 |
| 安全边界 | 细胞膜 | 不可突破的限制 |
| 目标函数 | 适应度 | 什么是"好" |

### 什么可以涌现

| 涌现内容 | 生物类比 | 说明 |
|---------|---------|------|
| 任务分配 | 细胞命运 | 谁做什么 |
| 协作模式 | 组织结构 | 怎么配合 |
| 专业化分工 | 器官形成 | 长期特化 |
| 错误恢复 | 再生修复 | 具体路径 |

### 涌现的基础：局部规则

```python
local_rules = [
    "任务太大 → 分解",
    "卡住超时 → 求助",
    "发现错误 → 报告并修复",
    "资源不足 → 等待或协商",
    "任务完成 → 广播结果",
    "长期空闲 → 凋亡",
]
```

**核心洞见**：不设计"Explorer 和 Coder 如何协作"，设计局部规则，让协作涌现。

---

## 九、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户                                 │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                      信号环境                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 任务队列  │  │ 事件总线  │  │ 状态存储  │  │ 直接通道  │    │
│  │ (旁分泌)  │  │ (内分泌)  │  │ (共享态)  │  │ (神经)   │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                     Agent 群落                               │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                  Stem Agent                          │   │
│   │  - 感知信号，判断分化/分裂                            │   │
│   │  - 知道所有分化规则                                   │   │
│   │  - 维持在龛位中                                       │   │
│   └─────────────────────────────────────────────────────┘   │
│                    ↓ 分化                                    │
│   ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│   │  Explorer  │  │   Coder    │  │  Guardian  │  ...      │
│   │  (感知)    │  │  (执行)    │  │  (防御)    │           │
│   └─────┬──────┘  └─────┬──────┘  └─────┬──────┘           │
│         │               │               │                   │
│         └───────────────┴───────────────┘                   │
│                         ↓                                    │
│                   任务完成 → 凋亡                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 十、内置 vs 外置

| 内置 | 说明 |
|------|------|
| Stem Agent 原型 | 包含分化规则的基础 prompt |
| 信号环境 | 任务队列 + 事件总线 + 状态存储 + 直接通道 |
| 生命周期管理 | 分裂、分化、凋亡、清除 |
| 平衡控制 | 数量限制、资源监控、僵尸检测 |

| 外置 | 说明 |
|------|------|
| 特化配置 | 各类型 Agent 的 prompt + tools |
| 分化规则 | 什么信号 → 什么类型 |
| 凋亡规则 | 什么条件 → 触发凋亡 |
| 协作规则 | 局部交互规则 |

---

## 十一、与 Claude Code 的对比

| | Claude Code | 生物模型 |
|--|-------------|---------|
| 起点 | 主 Agent + 6 种子 Agent | 1 个 Stem |
| 子 Agent | 预定义类型，硬编码 | 分化产生，可扩展 |
| 调度 | 主 Agent 显式调用 | 信号驱动，自组织 |
| 生命周期 | 调用结束即结束 | 自主凋亡 |
| 协作 | 子 Agent 之间不协作 | 通过信号协作 |
| 伸缩 | 不支持 | 分裂/凋亡 |
| 通讯 | 单一（调用返回） | 多层（内分泌/旁分泌/神经） |
| 容错 | 无 | 僵尸检测、去分化恢复 |

---

## 十二、设计原则总结

1. **龛位决定命运**：Agent 能力由环境配置，不是硬编码
2. **信号驱动**：没有中央调度，Agent 自己感知、自己决定
3. **局部规则 → 全局涌现**：不设计协作模式，设计交互规则
4. **分层可逆**：浅层分化可逆，深层分化不可逆
5. **多层通讯**：关键路径用直接通道，一般协调用消息队列
6. **主动凋亡**：Agent 自己决定何时死，不是被杀死
7. **多层防护**：资源监控 → 数量限制 → 僵尸检测 → 强制清理
8. **保留可塑性**：紧急情况下 Worker 可去分化为 Stem

---

## 十三、反思：生物模型的适用边界

### Agent 不是细胞

| | 细胞 | Agent |
|--|------|-------|
| 创建成本 | 高（分裂需要时间和资源） | 低（一次 API 调用） |
| 销毁成本 | 高（资源浪费） | 低（停止调用即可） |
| 改变功能 | 难（需要基因表达调控） | 易（换一个 prompt） |
| 物理实体 | 是 | 否 |

### 分化可能是过度设计

**生物为什么需要分化？**
- 因为细胞创建成本高，不能随意创建特化细胞
- 所以从全能细胞逐步特化

**Agent 需要分化吗？**
- 如果知道需要什么类型，直接创建就行
- 分化增加了复杂度，但不一定带来收益

### 生物模型真正有价值的部分

| 概念 | 价值 | 是否需要"分化" |
|------|------|---------------|
| 信号机制 | Agent 间通信的多种方式 | 不需要 |
| 自组织 | Agent 自己决定做什么 | 不需要 |
| 凋亡 | Agent 自己决定何时销毁 | 不需要 |
| 静息/休眠 | Agent 状态的保存和恢复 | 不需要 |
| 龛位 | Agent 运行环境的配置 | 不需要 |

### 简化后的核心模型

```
Agent 系统的核心：
1. 创建：直接创建，指定类型和配置
2. 销毁：自主凋亡 或 外部指令
3. 状态：活跃 / 静息 / 休眠
4. 通信：信号环境（多种方式）
5. 协作：自组织（响应需求，而不是被调度）
6. 持久化：身份、状态、关系都可以持久化
```

### 中央调度 vs 自组织

```
中央调度：A 分派任务给 C
- A 必须知道 C 存在
- A 必须知道 C 能做什么
- 新增 Agent 需要更新 A 的知识

自组织：C 响应 A 的需求
- A 不需要知道 C 存在
- A 只需要描述需求
- 新增 Agent 自动可用
```

**选择依据**：
- Agent 类型固定、数量少 → 中央调度更简单
- Agent 类型动态、数量多 → 自组织更灵活

### 团队协作的设计

**任务面板优于 Token 预算**：

```
┌─────────────────────────────────────────────────────────┐
│                    团队任务面板                          │
│                                                         │
│   任务 ID    状态        认领者      进度               │
│   ─────────────────────────────────────────────────    │
│   T-001     进行中      Coder-01    70%                │
│   T-002     待认领      -           -                  │
│   T-003     已完成      Explorer-01  100%              │
│   T-004     阻塞        Coder-02    30% (等待 T-001)   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

- 任务面板是"信息共享"，不是"资源限制"
- Agent 看到全局状态，自己决策
- 更符合自组织原则

### Agent 间连接的建立

**不是 A 找到 C，是 C 响应 A 的需求**：

```
A 需要和"能做代码审查的 Agent"协作
    ↓
A 不知道具体是谁
    ↓
A 发出信号："需要代码审查能力"
    ↓
信号环境传播这个需求
    ↓
C（Reviewer）感知到信号，响应
    ↓
A 和 C 建立连接
```

类比神经发育：轴突不"知道"目标在哪，是目标区域释放吸引信号，轴突沿着信号找过去。

---

## 十四、待解决的问题

1. **信号的具体 schema 设计** — 需要实践中迭代
2. **静息/休眠的触发条件** — 需要实验调优
3. **多 Agent 的一致性保证** — 可能需要某种共识机制
4. **长期记忆怎么处理** — 跨会话的知识积累
5. **涌现在生产中的可控性** — 模板 + 约束的平衡
